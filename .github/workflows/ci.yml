name: ci

on:
  pull_request:
  push:

permissions:
  contents: read

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Run tests
        run: go test ./...

  beta_guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build secrets-guard image (CI)
        run: docker build -t secrets-guard:ci .

      - name: PR added-lines should BLOCK on AWS_ACCESS_KEY_ID (Rule 1)
        if: startsWith(github.event.pull_request.title, 'beta: added-lines BLOCK')
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"
          set +e
          out="$(docker run --rm -e "GITHUB_SHA=$HEAD_SHA" -e "GITHUB_BASE_SHA=$BASE_SHA" -v "${GITHUB_WORKSPACE}:/work" secrets-guard:ci)"
          code=$?
          echo "$out"
          if [ "$code" -ne 2 ]; then
            echo "EXPECTED_EXIT_2_BLOCKED_BUT_GOT:$code" >&2
            exit 1
          fi
          echo "$out" | grep -q '"findings_count":1' || (echo "EXPECTED_findings_count_1_NOT_FOUND" >&2; exit 1)

      - name: PR remove secret-like pattern; CI must PASS
        if: startsWith(github.event.pull_request.title, 'beta: remove secret-like pattern')
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"
          set +e
          out="$(docker run --rm -e "GITHUB_SHA=$HEAD_SHA" -e "GITHUB_BASE_SHA=$BASE_SHA" -v "${GITHUB_WORKSPACE}:/work" secrets-guard:ci)"
          code=$?
          echo "$out"
          if [ "$code" -ne 0 ]; then
            echo "EXPECTED_EXIT_0_CLEAN_BUT_GOT:$code" >&2
            exit 1
          fi
          echo "$out" | grep -q '"findings_count":0' || (echo "EXPECTED_findings_count_0_NOT_FOUND" >&2; exit 1)

      - name: PR multiple findings in ONE added line (Rule1+Rule3) must BLOCK and report 2 findings
        if: startsWith(github.event.pull_request.title, 'beta: multiple findings test')
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"
          set +e
          out="$(docker run --rm -e "GITHUB_SHA=$HEAD_SHA" -e "GITHUB_BASE_SHA=$BASE_SHA" -v "${GITHUB_WORKSPACE}:/work" secrets-guard:ci)"
          code=$?
          echo "$out"
          if [ "$code" -ne 2 ]; then
            echo "EXPECTED_EXIT_2_BLOCKED_BUT_GOT:$code" >&2
            exit 1
          fi
          echo "$out" | grep -q '"findings_count":2' || (echo "EXPECTED_findings_count_2_NOT_FOUND" >&2; exit 1)

      - name: Synthetic validation â€” historical secret exists but unchanged => PASS (added-lines only)
        shell: bash
        run: |
          set -euo pipefail
          tmp="${RUNNER_TEMP}/sg_hist"
          rm -rf "$tmp"
          mkdir -p "$tmp"
          cd "$tmp"
          git init >/dev/null
          git config user.email "ci@local" >/dev/null
          git config user.name  "ci" >/dev/null

          # base commit contains secret-like line
          printf "AWS_ACCESS_KEY_ID=AKIA1234567890ABCDEF\nhello=world\n" > app.env
          git add -A >/dev/null
          git commit -m "base" >/dev/null
          BASE_SHA="$(git rev-parse HEAD)"

          # head commit changes unrelated file only (secret remains, but diff should not include it)
          printf "note=ok\n" > note.txt
          git add -A >/dev/null
          git commit -m "head" >/dev/null
          HEAD_SHA="$(git rev-parse HEAD)"

          set +e
          out="$(docker run --rm -e "GITHUB_SHA=$HEAD_SHA" -e "GITHUB_BASE_SHA=$BASE_SHA" -v "${tmp}:/work" secrets-guard:ci)"
          code=$?
          echo "$out"
          if [ "$code" -ne 0 ]; then
            echo "EXPECTED_EXIT_0_CLEAN_BUT_GOT:$code" >&2
            exit 1
          fi
          echo "$out" | grep -q '"findings_count":0' || (echo "EXPECTED_findings_count_0_NOT_FOUND" >&2; exit 1)